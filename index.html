<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>trochyen2</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    #login-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; background: #fff; border-radius: 8px; }
    #login-section h3 { margin-top: 0; color: #333; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; background: white; margin-bottom: 10px; }
    .msg { margin: 5px 0; padding: 5px; border-bottom: 1px dotted #eee; display: flex; justify-content: space-between; align-items: center; }
    .msg-content { flex-grow: 1; }
    .me { color: blue; font-weight: bold; }
    .you { color: green; font-weight: bold; }
    .delete-btn {
      background-color: #f44336; /* Red */
      color: white;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 10px;
      transition: background-color 0.3s ease;
    }
    .delete-btn:hover {
      background-color: #d32f2f;
    }
    input[type="text"], input[type="password"], button { padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #4CAF50; color: white; cursor: pointer; }
    button:hover { background-color: #45a049; }
    #login-error { color: red; margin-top: 10px; }
    #logout-btn {
        background-color: #f44336; /* Red */
        margin-left: 10px;
    }
    #logout-btn:hover {
        background-color: #d32f2f;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body>

  <h2>üí¨ chatwed th·ª© 2</h2>

  <div id="login-section">
    <h3>ƒêƒÉng nh·∫≠p / V√†o chat</h3>
    <p>T√™n ng∆∞·ªùi d√πng:</p>
    <input type="text" id="loginUsername" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." />
    <p>M·∫≠t kh·∫©u (t√πy ch·ªçn, ch·ªâ cho Admin):</p>
    <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u (n·∫øu c√≥)..." />
    <button onclick="login()">V√†o chat</button>
    <div id="login-error"></div>
  </div>

  <div id="chat" style="display:none;">
    <p>Ch√†o m·ª´ng: <span id="displayUsername"></span></p>
    <button id="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    <div id="messages"></div>
    <input id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
    <button onclick="sendMessage()">G·ª≠i</button>
  </div>

  <script>
    // C·∫•u h√¨nh Firebase (Do ƒê·∫°t cung c·∫•p - KH√îNG THAY ƒê·ªîI TR·ª™ KHI B·∫†N C·∫¨P NH·∫¨T D·ª∞ √ÅN)
    const firebaseConfig = {
  apiKey: "AIzaSyAVUzjEtWAw5uY_geuXDdgOkdnwfCOQCy8",
  authDomain: "chatwedcuatoi.firebaseapp.com",
  databaseURL: "https://chatwedcuatoi-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatwedcuatoi",
  storageBucket: "chatwedcuatoi.firebasestorage.app",
  messagingSenderId: "438404723863",
  appId: "1:438404723863:web:3657f3b034e1b0a79265d2",
  measurementId: "G-M2MEQXY40M"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i v√† tr·∫°ng th√°i admin
    let currentUsername = "";
    let currentIsAdmin = false;

    // --- C·∫•u h√¨nh Admin ---
    // QUAN TR·ªåNG: ƒê√¢y l√† c√°ch x√°c th·ª±c admin ph√≠a client.
    // ƒê·ªëi v·ªõi c√°c ·ª©ng d·ª•ng th·ª±c t·∫ø, quy·ªÅn admin n√™n ƒë∆∞·ª£c qu·∫£n l√Ω an to√†n h∆°n
    // th√¥ng qua Firebase Security Rules v√†/ho·∫∑c x√°c th·ª±c ph√≠a server.
    const ADMIN_USERNAME = '<p style="color:red;">ziolet</p>';
    const ADMIN_PASSWORD = "Dat";   

    // --- Ch·ª©c nƒÉng ƒêƒÉng nh·∫≠p / V√†o chat ---
    function login() {
      const enteredUsername = document.getElementById("loginUsername").value.trim();
      const enteredPassword = document.getElementById("loginPassword").value.trim();
      const loginErrorDiv = document.getElementById("login-error");

      // X√≥a th√¥ng b√°o l·ªói c≈©
      loginErrorDiv.textContent = "";

      if (enteredUsername === "") {
        loginErrorDiv.textContent = "Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng c·ªßa b·∫°n.";
        return;
      }

      // Ki·ªÉm tra admin login
      if (enteredUsername === ADMIN_USERNAME && enteredPassword === ADMIN_PASSWORD) {
        currentIsAdmin = true;
        currentUsername = enteredUsername;
        alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi quy·ªÅn Admin!");
      } else {
        // Guest login (ho·∫∑c ng∆∞·ªùi d√πng th∆∞·ªùng)
        currentIsAdmin = false;
        currentUsername = enteredUsername;
        if (enteredPassword !== "") {
            alert("ƒêƒÉng nh·∫≠p v·ªõi t√™n ng∆∞·ªùi d√πng th∆∞·ªùng. M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c ho·∫∑c kh√¥ng √°p d·ª•ng.");
        } else {
            alert("Ch√†o m·ª´ng kh√°ch " + currentUsername + "!");
        }
      }

      // C·∫≠p nh·∫≠t giao di·ªán sau khi ƒëƒÉng nh·∫≠p
      document.getElementById("login-section").style.display = "none";
      document.getElementById("chat").style.display = "block";
      document.getElementById("displayUsername").textContent = currentUsername;
      
      // G·∫Øn ho·∫∑c g·∫Øn l·∫°i tr√¨nh l·∫Øng nghe tin nh·∫Øn
      attachMessageListeners();
    }

    // --- Ch·ª©c nƒÉng ƒêƒÉng xu·∫•t ---
    function logout() {
        currentUsername = "";
        currentIsAdmin = false;
        
        // C·∫≠p nh·∫≠t giao di·ªán khi ƒëƒÉng xu·∫•t
        document.getElementById("login-section").style.display = "block";
        document.getElementById("chat").style.display = "none";
        document.getElementById("displayUsername").textContent = "";
        
        // X√≥a h·∫øt tin nh·∫Øn tr√™n UI v√† ng·∫Øt k·∫øt n·ªëi l·∫Øng nghe
        msgBox.innerHTML = ''; 
        db.ref("messages").off(); // Ng·∫Øt k·∫øt n·ªëi t·∫•t c·∫£ c√°c l·∫Øng nghe
        alert("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t.");
    }

    // --- G·ª≠i tin nh·∫Øn ---
    function sendMessage() {
      const msgInput = document.getElementById("messageInput");
      const text = msgInput.value.trim();
      if (text !== "") {
        // T√™n ng∆∞·ªùi g·ª≠i s·∫Ω l√† username hi·ªán t·∫°i
        db.ref("messages").push({
          name: currentUsername,
          message: text,
          timestamp: Date.now()
        });
        msgInput.value = "";
      }
    }

    // --- X√≥a tin nh·∫Øn ---
    function deleteMessage(messageKey) {
      if (!currentIsAdmin) { // Ki·ªÉm tra bi·∫øn currentIsAdmin ph√≠a client (ch·ªâ ƒë·ªÉ UX)
        alert("B·∫°n kh√¥ng c√≥ quy·ªÅn ƒë·ªÉ x√≥a tin nh·∫Øn n√†y.");
        return;
      }
      // X√°c nh·∫≠n t·ª´ ng∆∞·ªùi d√πng
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin nh·∫Øn n√†y kh√¥ng?")) {
        // Th·ª±c hi·ªán x√≥a tr√™n Firebase Realtime Database
        db.ref("messages").child(messageKey).remove()
          .then(() => {
            console.log("Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.");
            // Giao di·ªán s·∫Ω t·ª± c·∫≠p nh·∫≠t nh·ªù l·∫Øng nghe child_removed
          })
          .catch(error => {
            console.error("L·ªói khi x√≥a tin nh·∫Øn:", error);
            alert("Kh√¥ng th·ªÉ x√≥a tin nh·∫Øn: " + error.message + "\n(L∆∞u √Ω: Quy·ªÅn x√≥a th·ª±c s·ª± do Firebase Security Rules c·ªßa b·∫°n quy·∫øt ƒë·ªãnh, kh√¥ng ph·∫£i code n√†y!)");
          });
      }
    }

    // --- Hi·ªÉn th·ªã tin nh·∫Øn v√† qu·∫£n l√Ω n√∫t x√≥a ---
    const msgBox = document.getElementById("messages");

    // H√†m ƒë·ªÉ g·∫Øn/g·∫Øn l·∫°i c√°c tr√¨nh l·∫Øng nghe Firebase
    function attachMessageListeners() {
        // ƒê·∫ßu ti√™n, ng·∫Øt k·∫øt n·ªëi b·∫•t k·ª≥ tr√¨nh l·∫Øng nghe hi·ªán c√≥ n√†o ƒë·ªÉ ngƒÉn ch·∫∑n tr√πng l·∫∑p
        db.ref("messages").off(); 
        msgBox.innerHTML = ''; // X√≥a h·∫øt tin nh·∫Øn c≈© tr√™n UI tr∆∞·ªõc khi t·∫£i l·∫°i

        // G·∫Øn tr√¨nh l·∫Øng nghe child_added
        db.ref("messages").on("child_added", function (snapshot) {
            const data = snapshot.val();
            const messageKey = snapshot.key;

            const div = document.createElement("div");
            div.classList.add("msg");
            div.setAttribute('data-key', messageKey);

            // So s√°nh t√™n ng∆∞·ªùi g·ª≠i v·ªõi t√™n ng∆∞·ªùi d√πng hi·ªán t·∫°i ƒë·ªÉ t√¥ m√†u
            const isMe = (currentUsername && data.name === currentUsername);
            const who = isMe ? "me" : "you";
            
            const messageContent = document.createElement("span");
            messageContent.classList.add("msg-content");
            messageContent.innerHTML = `<span class="${who}">${data.name}:</span> ${data.message}`;
            
            div.appendChild(messageContent);

            // Th√™m n√∫t x√≥a ch·ªâ n·∫øu ng∆∞·ªùi d√πng hi·ªán t·∫°i l√† admin
            if (currentIsAdmin) {
                const deleteButton = document.createElement("button");
                deleteButton.classList.add("delete-btn");
                deleteButton.textContent = "X√≥a";
                deleteButton.onclick = function() {
                    deleteMessage(messageKey);
                };
                div.appendChild(deleteButton);
            }

            msgBox.appendChild(div);
            msgBox.scrollTop = msgBox.scrollHeight;
        });

        // G·∫Øn tr√¨nh l·∫Øng nghe child_removed
        db.ref("messages").on("child_removed", function (oldSnapshot) {
            const messageKey = oldSnapshot.key;
            const elementToRemove = msgBox.querySelector(`.msg[data-key="${messageKey}"]`);
            if (elementToRemove) {
                elementToRemove.remove();
            }
        });
    }

    // --- Kh·ªüi t·∫°o ban ƒë·∫ßu ---
    // L·∫Øng nghe tin nh·∫Øn ngay c·∫£ khi ch∆∞a ƒëƒÉng nh·∫≠p ƒë·ªÉ hi·ªÉn th·ªã l·ªãch s·ª≠ chat
    // Tuy nhi√™n, c√°c n√∫t x√≥a s·∫Ω kh√¥ng xu·∫•t hi·ªán cho ƒë·∫øn khi admin ƒëƒÉng nh·∫≠p.
    attachMessageListeners(); // Hi·ªÉn th·ªã tin nh·∫Øn ngay khi t·∫£i trang.
  </script>

</body>
  </html>
  
